name: Build Android App

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm install

      # Java 21 (Obrigat√≥rio para sua chave nova)
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Sync Capacitor
        run: npx cap sync android

      # --- ETAPA CR√çTICA: PREPARA√á√ÉO DA CHAVE ---
      - name: Prepare Keystore
        id: prepare_key
        run: |
          # 1. Tenta achar o arquivo original no reposit√≥rio
          if [ -f "android/app/my-release-key.keystore" ]; then
            echo "‚úÖ Arquivo de chave encontrado no projeto!"
            cp android/app/my-release-key.keystore release.jks
          
          # 2. Se n√£o achar, tenta usar o Segredo (Base64)
          elif [ -n "${{ secrets.ANDROID_KEYSTORE_FILE }}" ]; then
            echo "‚ö†Ô∏è Arquivo n√£o encontrado. Tentando decodificar do Secret..."
            printf "%s" "${{ secrets.ANDROID_KEYSTORE_FILE }}" | base64 --decode > release.jks
          
          else
            echo "‚ùå Nenhuma chave encontrada! (Nem arquivo, nem secret)"
            exit 1
          fi

          # 3. TESTE DE FOGO: Verifica se a chave √© v√°lida antes de continuar
          echo "üîç Testando integridade da chave..."
          if keytool -list -keystore release.jks -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" -alias "${{ secrets.ANDROID_KEY_ALIAS }}" > /dev/null; then
            echo "üèÜ SUCESSO: A chave √© v√°lida e a senha funcionou!"
          else
            echo "üî• ERRO FATAL: O arquivo da chave est√° corrompido ou a senha/alias est√£o errados."
            echo "Verifique os Secrets no GitHub."
            exit 1
          fi

      - name: Build Android Release
        run: cd android && ./gradlew assembleRelease

      - name: Sign APK Manually
        run: |
          BUILD_TOOLS_VERSION="34.0.0"
          ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}
          ZIPALIGN="$ANDROID_SDK_ROOT/build-tools/$BUILD_TOOLS_VERSION/zipalign"
          APKSIGNER="$ANDROID_SDK_ROOT/build-tools/$BUILD_TOOLS_VERSION/apksigner"
          
          APK_PATH="android/app/build/outputs/apk/release/app-release-unsigned.apk"
          ALIGNED_APK="app-release-aligned.apk"
          SIGNED_APK="app-release-signed.apk"

          echo "üîç Alinhando APK..."
          $ZIPALIGN -v -p 4 $APK_PATH $ALIGNED_APK

          echo "‚úçÔ∏è Assinando APK..."
          $APKSIGNER sign --ks release.jks \
            --ks-key-alias "${{ secrets.ANDROID_KEY_ALIAS }}" \
            --ks-pass "pass:${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            --key-pass "pass:${{ secrets.ANDROID_KEY_PASSWORD }}" \
            --out $SIGNED_APK \
            $ALIGNED_APK

          echo "‚úÖ APK Assinado com Sucesso!"

      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-signed
          path: app-release-signed.apk