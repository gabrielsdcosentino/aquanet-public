name: Build Android App

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Node 22 (Para o Capacitor novo)
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm install

      # Java 21 (Compat√≠vel com sua Keystore)
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '21'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Sync Capacitor
        run: npx cap sync android

      # 1. Decodifica a Keystore dos Secrets para um arquivo f√≠sico
      - name: Decode Keystore
        env:
          ENCODED_STRING: ${{ secrets.ANDROID_KEYSTORE_FILE }}
        run: |
          echo $ENCODED_STRING > keystore-b64.txt
          base64 -d keystore-b64.txt > release.jks

      # 2. Constr√≥i o APK (Release)
      - name: Build Android Release
        run: cd android && ./gradlew assembleRelease

      # 3. ASSINATURA MANUAL (A Solu√ß√£o Definitiva)
      # Usa as ferramentas modernas (34.0.0) que entendem sua chave nova
      - name: Sign APK Manually
        run: |
          # Define caminhos das ferramentas
          BUILD_TOOLS_VERSION="34.0.0"
          ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT:-/usr/local/lib/android/sdk}
          ZIPALIGN="$ANDROID_SDK_ROOT/build-tools/$BUILD_TOOLS_VERSION/zipalign"
          APKSIGNER="$ANDROID_SDK_ROOT/build-tools/$BUILD_TOOLS_VERSION/apksigner"
          
          # Caminhos dos arquivos
          APK_PATH="android/app/build/outputs/apk/release/app-release-unsigned.apk"
          ALIGNED_APK="app-release-aligned.apk"
          SIGNED_APK="app-release-signed.apk"

          echo "üîç Alinhando APK..."
          $ZIPALIGN -v -p 4 $APK_PATH $ALIGNED_APK

          echo "‚úçÔ∏è Assinando APK..."
          $APKSIGNER sign --ks release.jks \
            --ks-key-alias "${{ secrets.ANDROID_KEY_ALIAS }}" \
            --ks-pass "pass:${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            --key-pass "pass:${{ secrets.ANDROID_KEY_PASSWORD }}" \
            --out $SIGNED_APK \
            $ALIGNED_APK

          echo "‚úÖ APK Assinado com Sucesso!"

      # 4. Upload do arquivo final
      - name: Upload Signed APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release-signed
          path: app-release-signed.apk
