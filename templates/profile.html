{% extends 'base.html' %}

{% block title %}Perfil de @{{ user.username }} - AquaNet{% endblock %}

{% block content %}
    <section class="bg-white p-6 rounded-lg shadow mb-5 text-center">
        <img src="{{ user.profile_pic_url }}" alt="Foto de Perfil de {{ user.username }}" class="w-24 h-24 md:w-32 md:h-32 rounded-full mx-auto border-4 border-gray-200 mb-4 object-cover">
        <h2 class="text-2xl font-semibold">@{{ user.username }}</h2>
        <div class="flex justify-center gap-6 my-4">
            <div><span class="font-bold text-lg">{{ user.followers.count() }}</span> <span class="text-gray-600">Seguidores</span></div>
            <div><span class="font-bold text-lg">{{ user.followed.count() }}</span> <span class="text-gray-600">Seguindo</span></div>
        </div>
        <div class="mt-4 mb-6">
            {% if user == current_user %}
                <a href="{{ url_for('edit_profile') }}" class="inline-block text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-full">Editar Perfil</a>
            {% else %}
                {% if current_user.is_following(user) %}
                    <form action="{{ url_for('unfollow', username=user.username) }}" method="POST" class="inline-block">
                         <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                         <button type="submit" class="text-sm bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-full">Deixar de Seguir</button>
                    </form>
                {% else %}  <form action="{{ url_for('follow', username=user.username) }}" method="POST" class="inline-block">
                         <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                         <button type="submit" class="text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-full">Seguir</button>
                    </form>
                {% endif %}
            {% endif %}
        </div>

        {% if all_badges %}
        <div class="pt-6 border-t border-slate-100">
            <h3 class="font-bold text-slate-800 text-sm mb-4 flex items-center justify-center gap-2">
                <i class="fas fa-trophy text-yellow-500"></i> Sala de Troféus
            </h3>
            <div class="grid grid-cols-3 md:grid-cols-4 gap-4 max-w-lg mx-auto pb-4">
                {% for badge in all_badges %}
                    {% set has_badge = badge in user.badges %}
                    <div class="flex flex-col items-center p-2 rounded-xl {{ 'hover:bg-slate-50' if has_badge else 'opacity-60 grayscale' }} transition-all group relative cursor-help z-0 hover:z-20">
                        
                        <div class="w-12 h-12 rounded-full {{ 'bg-' + badge.color + '-50 text-' + badge.color + '-500 border-' + badge.color + '-100' if has_badge else 'bg-slate-100 text-slate-400 border-slate-200' }} border flex items-center justify-center text-xl mb-2 shadow-sm {{ 'group-hover:scale-110' if has_badge else '' }} transition-transform">
                            <i class="{{ badge.icon }}"></i>
                        </div>
                        
                        <span class="text-[10px] font-bold {{ 'text-slate-600' if has_badge else 'text-slate-400' }} uppercase tracking-wide leading-tight">{{ badge.name }}</span>
                        
                        <div class="absolute top-full mt-2 hidden group-hover:block w-36 bg-slate-900 text-white text-[11px] p-3 rounded-xl z-50 shadow-xl border border-slate-700">
                            <p class="leading-relaxed">{{ badge.description }}</p>
                            {% if not has_badge %}
                            <div class="mt-2 text-yellow-400 font-bold uppercase text-[9px] border-t border-slate-700 pt-1 tracking-wider"><i class="fas fa-lock mr-1"></i> Bloqueado</div>
                            {% endif %}
                            <div class="absolute bottom-full left-1/2 -translate-x-1/2 border-8 border-transparent border-b-slate-900"></div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </section>

    <section>
        <h3 class="text-xl font-semibold mb-4 text-gray-800">Posts de @{{ user.username }}</h3>
        {% for post in posts %}
            <article class="bg-white rounded-lg shadow mb-4 overflow-hidden border border-gray-300 hover:border-gray-400 hover:shadow-md transition cursor-pointer relative">
                
                <a href="{{ url_for('post_detail', post_id=post.id) }}" class="absolute inset-0 z-0"></a>

                <div class="p-4">
                    <div class="text-xs text-gray-600 mb-2">
                        Postado em <a href="{{ url_for('community_feed', community_slug=post.community.slug) }}" class="font-semibold text-blue-700 hover:underline relative z-10">{{ post.community.name }}</a>
                    </div>
                    <p class="text-gray-800 text-base mb-3">{{ post.content }}</p>
                </div>
                {% if post.image_file %}
                    <div class="bg-gray-100">
                        <img src="{{ post.image_file }}" alt="Imagem do Post" class="w-full max-h-[500px] object-contain">
                    </div>
                {% endif %}
                <div class="p-4 flex items-center text-sm text-gray-600 font-semibold border-t border-gray-100 bg-gray-50 relative z-10">
                    <a href="{{ url_for('post_detail', post_id=post.id) }}" class="flex items-center hover:bg-gray-100 p-2 rounded-md mr-3 relative z-10">
                        <i class="far fa-comment-alt mr-1 text-lg"></i>
                        {{ post.comments|length }} Comentário(s)
                    </a>

                    <form action="{{ url_for('api_like_post', post_id=post.id) }}" method="POST" class="like-form flex items-center mr-auto relative z-10">
                        <button type="submit" class="like-button group flex items-center p-2 rounded-md transition {{ 'text-blue-600 hover:bg-blue-50' if current_user.has_liked_post(post) else 'text-gray-500 hover:bg-gray-200 hover:text-blue-600' }}">
                            <i class="{{ 'fas' if current_user.has_liked_post(post) else 'far' }} fa-thumbs-up text-lg mr-1 transition-transform group-active:scale-110"></i>
                            <span class="like-count-text font-semibold">
                                {{ post.likes|length if post.likes|length > 0 else '' }}
                            </span>
                        </button>
                    </form>
                    
                    {% if post.user_id == current_user.id or post.community.creator_id == current_user.id %}
                        <a href="{{ url_for('delete_post', post_id=post.id) }}" class="p-2 text-gray-400 hover:text-red-600 rounded-md transition-colors relative z-10" title="Excluir" onclick="return confirm('Excluir este post?')">
                            <i class="fas fa-trash-alt text-lg"></i>
                        </a>
                    {% endif %}
                </div>
            </article>
        {% else %}
            <p class="text-gray-600 text-center py-5 bg-white rounded-lg shadow">@{{ user.username }} ainda não fez nenhum post.</p>
        {% endfor %}
    </section>
{% endblock %}