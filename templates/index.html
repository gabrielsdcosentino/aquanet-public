{% extends 'base.html' %}

{% block title %}
    {% if current_community %} {{ current_community.name }} {% else %} AquaNet {% endif %}
{% endblock %}

{% block content %}

    {% if not current_community %}
    <div class="md:hidden bg-white/95 backdrop-blur-sm sticky top-14 z-30 border-b border-gray-100 py-3 px-4 shadow-sm">
        <div class="relative bg-slate-100 rounded-xl p-1 flex h-10">
            <div class="absolute top-1 bottom-1 w-[calc(50%-4px)] bg-white rounded-lg shadow-sm transition-all duration-300 ease-out border border-slate-200/50
                {% if request.endpoint == 'feed' %} left-[50%] ml-0.5 {% else %} left-1 {% endif %}">
            </div>

            <a href="{{ url_for('home') }}" class="relative z-10 flex-1 flex items-center justify-center text-sm font-bold transition-colors duration-300 {% if request.endpoint == 'home' %} text-blue-600 {% else %} text-gray-500 {% endif %}">
                Global
            </a>
            
            <a href="{{ url_for('feed') }}" class="relative z-10 flex-1 flex items-center justify-center text-sm font-bold transition-colors duration-300 {% if request.endpoint == 'feed' %} text-blue-600 {% else %} text-gray-500 {% endif %}">
                Seguindo
            </a>
        </div>
    </div>
    {% endif %}

    {% if current_community %}
        <div class="bg-white p-4 rounded-xl shadow-sm mb-5 border border-gray-100">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-2xl font-black text-gray-800 tracking-tight">{{ current_community.name }}</h2>
                    <p class="text-gray-600 text-sm mt-1 leading-relaxed">{{ current_community.description or "Sem descrição." }}</p>
                    <div class="flex items-center gap-3 mt-3">
                        <span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-md">
                            <i class="fas fa-users mr-1 text-blue-400"></i> {{ current_community.members.count() }} membros
                        </span>
                    </div>
                </div>
                
                <div class="flex flex-col items-end gap-2">
                    {% if current_user.is_member(current_community) %}
                        <form action="{{ url_for('leave_community', community_slug=current_community.slug) }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="text-xs font-bold border border-gray-200 text-gray-400 px-3 py-1 rounded-lg hover:bg-red-50 hover:text-red-500 hover:border-red-200 transition-all">
                                Sair
                            </button>
                        </form>
                    {% else %}
                        <form action="{{ url_for('join_community', community_slug=current_community.slug) }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="text-xs font-bold bg-blue-600 text-white px-5 py-1.5 rounded-full hover:bg-blue-700 transition shadow-md shadow-blue-200">
                                Entrar
                            </button>
                        </form>
                    {% endif %}

                    {% if current_community.creator_id == current_user.id or current_user.username == 'bielcosen14' %}
                        <form action="{{ url_for('delete_community', community_slug=current_community.slug) }}" method="POST" onsubmit="return confirm('ATENÇÃO: Isso apagará a comunidade e TODOS os posts dela. Tem certeza?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="text-[10px] font-bold text-gray-300 hover:text-red-600 transition-colors mt-1">
                                <i class="fas fa-trash-alt mr-1"></i> Excluir
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
            
            {% if current_user.is_member(current_community) %}
                <form method="POST" action="{{ url_for('community_feed', community_slug=current_community.slug) }}" enctype="multipart/form-data" class="border-t border-gray-100 pt-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="flex gap-3 items-start">
                        <img src="{{ current_user.profile_pic_url }}" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-sm hidden md:block">
                        
                        <div class="flex-1 min-w-0 bg-gray-50 p-3 rounded-2xl focus-within:ring-2 focus-within:ring-blue-100 focus-within:bg-white transition-all shadow-inner">
                            <textarea id="post-content" name="content" placeholder="No que você está pensando, {{ current_user.username }}?" 
                            class="w-full bg-transparent border-0 focus:ring-0 text-gray-700 placeholder-gray-400 text-sm resize-none min-h-[60px]" rows="2" maxlength="2500">{{ request.args.get('auto_content', '') }}</textarea>
                            
                            <div class="flex justify-between items-center mt-2 px-1 border-t border-gray-200/50 pt-2">
                                 <label class="cursor-pointer text-gray-400 hover:text-blue-500 transition-colors p-1.5 rounded-full hover:bg-blue-50 group" title="Adicionar mídia">
                                     <i class="fas fa-image text-lg group-hover:scale-110 transition-transform"></i>
                                     <input type="file" name="image" accept="image/*,video/mp4,video/mov,video/webm" class="hidden">
                                 </label>
                                 
                                 <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-5 rounded-full text-xs shadow-md shadow-blue-200 transform active:scale-95 transition-all">
                                     Publicar
                                 </button>
                            </div>
                        </div>
                    </div>
                </form>
            {% else %}
                <div class="mt-4 bg-gradient-to-r from-blue-50 to-white p-6 rounded-xl border border-blue-100 text-center">
                    <div class="mb-2 text-blue-300"><i class="fas fa-lock text-2xl"></i></div>
                    <p class="text-gray-700 font-medium mb-3 text-sm">Entre na comunidade para participar das discussões!</p>
                    <form action="{{ url_for('join_community', community_slug=current_community.slug) }}" method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="bg-blue-600 text-white px-8 py-2.5 rounded-full font-bold shadow-lg hover:bg-blue-700 transition transform hover:-translate-y-0.5 active:scale-95 text-sm">
                            Entrar na Comunidade
                        </button>
                    </form>
                </div>
            {% endif %}

        </div>
    {% endif %}

    <section id="feed-posts-container">
        {% if posts.items %}
            {% include 'post_list.html' %}
        {% else %}
            <div class="text-center py-16 px-4 bg-white rounded-xl shadow-sm border border-gray-100 mt-4">
                <div class="mb-4 inline-block p-4 bg-blue-50 rounded-full animate-bounce">
                    <i class="fas fa-fish text-4xl text-blue-400"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800">O aquário está vazio!</h3>
                <p class="text-gray-500 text-sm mt-1">Seja o primeiro a nadar por aqui e crie um post.</p>
            </div>
        {% endif %}
    </section>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.body.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'load-more-btn') {
            const btn = e.target;
            const container = document.getElementById('next-page-trigger');
            const nextPage = container.dataset.nextPage;
            
            btn.textContent = 'Carregando...';
            btn.disabled = true;

            fetch(`${window.location.pathname}?page=${nextPage}`, {
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(response => response.text())
            .then(html => {
                container.remove();
                document.getElementById('feed-posts-container').insertAdjacentHTML('beforeend', html);
            });
        }
    });
</script>
{% endblock %}