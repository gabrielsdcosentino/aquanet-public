{% extends 'base.html' %}

{% block title %}
    {% if current_community %} {{ current_community.name }} {% else %} AquaNet {% endif %}
{% endblock %}

{% block content %}

    {% if not current_community %}
    <div class="md:hidden flex border-b bg-white mb-4 sticky top-14 z-30 shadow-sm">
        <a href="{{ url_for('home') }}" class="flex-1 text-center py-3 font-semibold text-sm {% if request.endpoint == 'home' %} border-b-2 border-blue-600 text-blue-600 {% else %} text-gray-500 {% endif %}">Todos</a>
        <a href="{{ url_for('feed') }}" class="flex-1 text-center py-3 font-semibold text-sm {% if request.endpoint == 'feed' %} border-b-2 border-blue-600 text-blue-600 {% else %} text-gray-500 {% endif %}">Seguindo</a>
    </div>
    {% endif %}

    {% if current_community %}
        <div class="bg-white p-4 rounded-lg shadow mb-5">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">{{ current_community.name }}</h2>
                    <p class="text-gray-600 text-sm mt-1">{{ current_community.description }}</p>
                    <div class="text-xs text-gray-500 mt-2"><i class="fas fa-users mr-1"></i> {{ current_community.members.count() }} membros</div>
                </div>
                                <div class="flex flex-col items-end gap-2">
                    {% if current_user.is_member(current_community) %}
                        <form action="{{ url_for('leave_community', community_slug=current_community.slug) }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="text-xs font-bold border border-gray-300 text-gray-500 px-4 py-1.5 rounded-full hover:bg-red-50 hover:text-red-600 hover:border-red-200 transition">
                                Sair
                            </button>
                        </form>
                    {% else %}
                        <form action="{{ url_for('join_community', community_slug=current_community.slug) }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="text-xs font-bold bg-blue-600 text-white px-6 py-1.5 rounded-full hover:bg-blue-700 transition shadow-sm">
                                Entrar
                            </button>
                        </form>
                    {% endif %}

                    {% if current_community.creator_id == current_user.id or current_user.username == 'bielcosen14' %}
                        <form action="{{ url_for('delete_community', community_slug=current_community.slug) }}" method="POST" onsubmit="return confirm('ATENÇÃO: Isso apagará a comunidade e TODOS os posts dela. Tem certeza?')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="text-[10px] font-bold text-red-400 hover:text-red-600 hover:underline mt-1">
                                <i class="fas fa-trash-alt mr-1"></i> Excluir Comunidade
                            </button>
                        </form>
                    {% endif %}
                </div>

            </div>
            <form method="POST" action="{{ url_for('community_feed', community_slug=current_community.slug) }}" enctype="multipart/form-data" class="border-t pt-4">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="flex gap-3 items-start">
                    <img src="{{ current_user.profile_pic_url }}" class="w-10 h-10 rounded-full object-cover border border-gray-300 hidden md:block">
                    <div class="flex-1 min-w-0">
                        <textarea id="post-content" name="content" placeholder="Criar post..." class="w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500 min-h-[80px] resize-none" rows="2" maxlength="2500"></textarea>
                        <div class="mt-3 flex flex-wrap justify-between items-center gap-3">
                             <input type="file" name="image" accept="image/*,video/mp4,video/mov,video/webm" class="text-xs w-full sm:w-auto">
                             <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-6 rounded-full text-sm shadow-sm">Publicar</button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    {% endif %}

    <section id="feed-posts-container">
        {% if posts.items %}
            {% include 'post_list.html' %}
        {% else %}
            <div class="text-center py-10 bg-white rounded-lg shadow">
                <div class="mb-4 text-gray-300"><i class="far fa-comments text-5xl"></i></div>
                <h3 class="text-lg font-medium text-gray-900">Nada por aqui ainda</h3>
            </div>
        {% endif %}
    </section>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Lógica do Carregar Mais
    document.body.addEventListener('click', function(e) {
        if (e.target && e.target.id === 'load-more-btn') {
            const btn = e.target;
            const container = document.getElementById('next-page-trigger');
            const nextPage = container.dataset.nextPage;
            
            btn.textContent = 'Carregando...';
            btn.disabled = true;

            fetch(`${window.location.pathname}?page=${nextPage}`, {
                headers: {'X-Requested-With': 'XMLHttpRequest'}
            })
            .then(response => response.text())
            .then(html => {
                // Remove o botão antigo
                container.remove();
                // Adiciona os novos posts no final
                document.getElementById('feed-posts-container').insertAdjacentHTML('beforeend', html);
            });
        }
    });
</script>
{% endblock %}
